
<!DOCTYPE html>
<html>
<head>
  <title>Open Robotics Project Release Dashboard</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/bootstrap-table.min.css">
  <link rel="stylesheet" href="assets/css/fontawesome-free.min.css">
  <link rel="stylesheet" href="assets/css/highlightjs.min.css">
  <link rel="stylesheet" href="assets/css/hint.min.css">

  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/popper.min.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>
  <script src="assets/js/sprintf.min.js"></script>
  <script src="assets/js/highlight.min.js"></script>
  <script src="assets/js/bootstrap-table.min.js"></script>
  <script src="assets/js/bootstrap-table-locale-all.min.js"></script>
</head>
<body>

  <div class="container">
    <div class="row">
      <h1 id="head"></h1>
    </div>

    <ul>
      <li><a href="?distribution=rolling">Rolling</a></li>
      <li><a href="?distribution=humble">Humble</a></li>
    </ul>

    <ul>
      <li><a href="?distribution=fortress">Fortress</a></li>
      <li><a href="?distribution=garden">Garden</a></li>
    </ul>

    <div class="row">
      <table
        class="table table-striped"
        id="table"
        data-search="true"
        data-response-handler="responseHandler">
      </table>
    </div>
    <div class="row">
      <p id="generated">Generated on: </p>
    </div>
</body>

<script>
  var $table = $('#table')
  var $head = $('#head')
  var $generated = $('#generated')

  const params = new URLSearchParams(window.location.search);
  const distribution = params.get("distribution");

  function responseHandler(res) {

    const date = new Date(res.generation_time)

    $head.text('Distribution Status: ' + res.name)
    $generated.text('Generated on: ' + date)
    return res.repos
  }

  function nameFormatter(value, row) {
      return '<a href="' + row.url + '">' + row.name + '</a>'
  }

  function branchFormatter(value, row) {
      if (row.branch)
        return '<a href="' + row.branch.url + '">' + row.branch.name + '</a>'
      else
        return "DETACHED"
  }

  function commitFormatter(value, row) {
      const options = {
        year: "numeric",
        month: "long",
        day: "numeric",
     };

      const date = new Date(row.latest_commit.commit_date)

      ret = '<a href="' + row.latest_commit.url + '">' + row.latest_commit.SHA.slice(0,8) + '</a>'
      ret += '<br/>' + row.latest_commit.author
      ret += '<br/>' + date.toLocaleString('en-US', options)
      return ret
  }

  function tagFormatter(value, row) {
      if (row.latest_tag === undefined)
        return "DETACHED"

      const options = {
        year: "numeric",
        month: "long",
        day: "numeric",
     };
      const date = new Date(row.latest_tag.commit_date)

      ret = '<a href="' + row.latest_tag.url+ '">' + row.latest_tag.name+ '</a>'
      ret += '<br/>' + row.latest_tag.author
      ret += '<br/>' + date.toLocaleString('en-US', options)
      return ret
  }

  function commitDeltaFormatter(value, row) {
      if (row.release_delta === undefined)
        return "DETACHED"

      ret = '<a href="'  + row.release_delta.url + '">' + row.release_delta.commit_count + '</a>'
      return ret
  }

  function daysSinceRelease(value, row) {
    }

  function diffstatFormatter(index, row) {
      console.log(row)
      return row.release_delta.diffstat.join('<br/>');
  }

  function initTable() {
    $table.bootstrapTable({
      url: distribution + '.json',
      locale: 'en-us',
      columns: [{
          field: 'name',
          title: 'Name',
          formatter: nameFormatter,
          searchable: true,
        },
        {
          field: 'branch',
          title: 'Branch',
          formatter: branchFormatter,
          searchable: true,
        },
        {
          field: 'latest_commit',
          title: 'Latest Commit',
          formatter: commitFormatter,
          searchable: false,
        },
        {
          title: 'Days since commit',
          searchable: false,
          formatter: (value, row) => {
            if (row.release_delta === undefined)
              return "-"
            return row.release_delta.head_to_now.days
          }
        },
        {
          field: 'latest_tag.name',
          searchable: false,
          title: 'Latest Tag',
          formatter: tagFormatter
        },
        {
          title: 'Days since release',
          searchable: false,
          formatter: (value, row) => {
            if (row.release_delta === undefined)
              return "-"
            return row.release_delta.tag_to_now.days
          }
        },
        {
          title: 'Commits since release',
          formatter: commitDeltaFormatter,
          searchable: false
        },
      ]
    })
  }

  $(function() {
    initTable()
  })
</script>
</body>
</html>
